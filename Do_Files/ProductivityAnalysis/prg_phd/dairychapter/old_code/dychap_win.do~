*****************************************************
*****************************************************
* REDP Book - Dairy Chapter
*
* Patrick R. Gillespie		
*
* 2012
*
*
*****************************************************
* Input files - nfs_data.dta
*               regional_weights.dta
*               doFarmDerivedVars.do
* Output files - nfs_d210.dta (intermediate data)
*              - nfs_yr2010.csv (aggregated data)
*****************************************************




clear
set mem 700m
set more off
set matsize 500

capture log close
capture cmdlog close



*****************************************************
* Declare local macros for directory paths
*****************************************************
local dodir F:/Documents/projects/phd/dairychapter
local nfsdatadir F:/Data/data_NFSPanelAnalysis/OutData
local origdatadir F:/Data/data_NFSPanelAnalysis/OrigData 
local outdatadir F:/Data/phd
local Regional_outdatadir F:/Data/data_NFSPanelAnalysis/OutData/RegionalAnalysis



*****************************************************
* Set working directory and start logs
*****************************************************
cd `dodir'
log using dychap_win.log, replace 
di  "Job  Started  at  $S_TIME  on $S_DATE"



*****************************************************
* Merge in weights
*****************************************************

use `nfsdatadir'\nfs_data.dta, clear
sort farmcode year
merge farmcode year using `Regional_outdatadir'\regional_weights.dta
drop _merge
*drop if region == . //turned off until I regional_weights.dta gets 95-96
tabstat wt region, by(year)


*****************************************************
* Get derived variables
*****************************************************
* To run analysis starting from nfs_data.dta uncomment
* the following. In the interest of transparency and
* reproducibility, this should be done to obtain final 
* results. Leave it turned off when doing intermediate
* program runs to save time. Don't forget to save the 
* intermediate dataset again when debugging.

*do doFarmDerivedVars.do
*save `nfsdatadir'/nfs_9508_d, replace


* closes any logs the previous do-file may have left
* open restarts this file's log
capture log close
log using dychap_win.log, append

* Starts from the intermediate dataset as a shortcut
use `nfsdatadir'/nfs_d210, replace

* restrict data to the desired years
drop 2009

*****************************************************
* System selection
*****************************************************

gen syst = ffszsyst-int(ffszsyst/10)*10
keep if syst == 1 | syst == 2



*****************************************************
* Code borrowed from 
* data_NFSPanelAnalysis/Do_Files/FarmLevelModel/FarmLevel_dairy.do
* ... originally thought it was Thia's, but she wasn't
* familiar with it, although her name is on the file.
* 
* Subset
* Keep only farms with dairy gross output
*****************************************************

* Farms with no milk sales
keep if fdairygo > 0 & fdairygo < .
keep if doslcmgl > 0 & doslcmgl < .


* Farms with 50% liquid milk sales
keep if dosllmgl < 0.5*dotomkgl


* No herds with less than 10 dairy cows
keep if dpopinvd > 10

*****************************************************
* Check for proper units
*****************************************************

* Variables which could be in gallons or litres
local gl2lt_vlist "lt_lu doslcmgl dosllmgl domkfdgl doslmkgl"
local gl2lt_plist "p_doslcm p_dosllm p_domkfd"

* this table makes it clear that the dataset has units in gallons for years < 2002
tabstat year `gl2lt_vlist', by(year)
tabstat year `gl2lt_plist', by(year)

* convert pre-2002 to litres
foreach var in `gl2lt_vlist'{
	replace `var' = `var'*4.54609 if year <= 2001
}

foreach var in `gl2lt_plist'{
	replace `var' = `var'/4.54609 if year <= 2001
}

* but this suggests that monetary units are already converted to euro for the pre 1999 years
tabstat p_* *vl*, by(year)



*****************************************************
* Subset and collapse data to relevant var's per year 
*****************************************************

* create local macros of vars to keep when dataset is collapsed
local fdairy = "fdairygo fdairygm fdairydc"
local farm = "farmgo farmgm farmdc farmffi"
local go_vlist = "daforare doslcmgl  domlkbon  domlkpen  dosllmgl  domkfdgl  domkalvl  docftfvl docftfno docfslvl docfslno  doschbvl  dotochbv dotochbn  dopchbvl dopchbno  dotichbv dotichbn  dovlcnod" 

local go_plist = "p_doslcm p_dosllm p_domkfd p_docftfvl p_docfslvl p_dotochbv p_dopchbvl p_dotichbv" 

local ct_vlist = "dpnolu ddconvalq ddpasturq ddwinforq d_othmiscdcq ivmalldyq iaisfdyq itedairyq imiscdryq flabccdyq"

local ct_plist = "PCattleFeed PTotalFert POtherInputs PVetExp PMotorFuels PLabour"



* recreate per ha measures


outsheet using F:/Data/nfs_yr2010.csv, comma replace
capture log close


*drop *_ha *_lu *_lt
*foreach var in `farm'{
*	gen `var'_ha = `var'/daforare
*}
*
*foreach var in `fdairy'{
*	gen `var'_ha = `var'/daforare
*}
*
*foreach var in `go_vlist'{
*	gen `var'_ha = `var'/daforare
*}
*
*foreach var in `ct_vlist'{
*	gen `var'_ha = `var'/daforare
*}
*
** recreate per lu measures
*foreach var in `farm'{
*	gen `var'_lu = `var'/dpnolu
*}
*
*foreach var in `fdairy'{
*	gen `var'_lu = `var'/dpnolu
*}
*
*foreach var in `go_vlist'{
*	gen `var'_lu = `var'/dpnolu
*}
*
*foreach var in `ct_vlist'{
*	gen `var'_lu = `var'/dpnolu
*}
*
** recreate per lt measures
*foreach var in `farm'{
*	gen `var'_lt = `var'/doslcmgl
*}
*
*foreach var in `fdairy'{
*	gen `var'_lt = `var'/doslcmgl
*}
*
*foreach var in `go_vlist'{
*	gen `var'_lt = `var'/doslcmgl
*}
*
*foreach var in `ct_vlist'{
*	gen `var'_lt = `var'/doslcmgl
*}
*
*collapse lt_lu doslmkgl `fdairy' `farm' `go_vlist' `go_plist' `ct_vlist' `ct_plist' *_ha *_lu *_lt [weight=wt], by(year)
*
*foreach var of varlist fdairygo fdairygm fdairydc{
*	local ch1= substr("`var'", -2, 2)
*	foreach unit of varlist daforare doslmkgl dpnolu{
*		local ch2 = substr("`unit'", -2, 2)
*		gen `ch1'_`ch2'= `var'/`unit'
*	}
*}
